#!/bin/bash

# A concise script to create a git worktree off of the main branch
# and set up direnv.

# 1. Check for required arguments (repo name and branch name)
if [ -z "$2" ]; then
  echo "Usage: $0 <repo-name> <new-branch-name>"
  exit 1
fi

REPO_NAME="$1"
BRANCH_NAME="$2"
# Determine the base branch (prefer 'main', fallback to 'master')
BASE_BRANCH=$(git rev-parse --verify main > /dev/null 2>&1 && echo main)

# Construct the worktree path (e.g., mono-rn-0001)
WORKTREE_PATH="../${REPO_NAME}-${BRANCH_NAME}"

echo "--- Setting up worktree '$BRANCH_NAME' from '$BASE_BRANCH' at '$WORKTREE_PATH' ---"

# 2. Create the worktree:
#    -b <branch> creates the new branch
#    <path> is the relative path for the new worktree directory
#    <commit> is the branch/commit to base the new branch on ($BASE_BRANCH)
git worktree add -b "feat/$BRANCH_NAME" "$WORKTREE_PATH" "$BASE_BRANCH"

if [ $? -ne 0 ]; then
  echo "Error: Git worktree creation failed. Check for existing directories or branches."
  exit 1
fi
echo "--- Success! Worktree is ready. ---"

# 3. Set up direnv:
echo "Setting up .envrc for direnv..."
cat .envrc > "$WORKTREE_PATH/.envrc"

# 4. Change to worktree directory
cd $WORKTREE_PATH
echo "--- Directory changed to: $WORKTREE_PATH ---"

# 5. Setup environment and confirm
direnv allow
echo "--- Ready! ---"
echo "--- Directory:  $(pwd) ---"
echo "--- Branch:     $(git rev-parse --abbrev-ref HEAD) ---"
echo "--- ****** ---"
